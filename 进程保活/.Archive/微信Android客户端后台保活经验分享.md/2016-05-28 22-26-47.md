# 微信Android客户端后台保活经验分享

来源:[infoQ](http://www.infoq.com/cn/articles/wechat-android-background-keep-alive)

[TOC]

本文为『移动前线』群在3月31日的分享总结整理而成，转载请注明来自『移动开发前线』公众号。

**嘉宾介绍**

**杨干荣**，微信Android客户端基础平台、性能优化负责人

保活，按照我们的理解包含两部分：

* **网络连接保活：**如何保证消息接收实时性。
* **进程保活：**尽量保证应用的进程不被Android系统回收。

## 1.0 网络连接保活

网络保活，业界主要手段有：

* a. GCM
* b. 公共的第三方push通道(信鸽等)
* c. 自身跟服务器通过轮询，或者长连接

国产机器大多缺乏GMS，在国内GCM也不稳定(心跳原因)，第三方通道需要考虑安全问题和承载能力，最后微信选择使用自己的长连接。而国外， GCM作为辅助，微信无法建立长连接时，才使用GCM。

之前看到大家在聊各种Java网络框架，而微信实际上都是没用上的。早年的微信，直接通过Java socket 实现。微信v5.0后，考虑各系统平台的统一，开始使用自研c++组件。

长连接实现包括几个要素：

* a. 网络切换或者初始化时 server ip 的获取。
* b. 连接前的 ip筛选，出错后ip 的抛弃。
* c. 维护长连接的心跳。
* d. 服务器通过长连notify。
* e. 选择使用长连通道的业务。
* f. 断开后重连的策略。

今天主题在保活，  我们重点讨论心跳和 notify 机制。

1.1 心跳机制

心跳的目的很简单：通过定期的数据包，对抗NAT超时。以下是部分地区网络NAT 超时统计：
